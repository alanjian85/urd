# SPDX-FileCopyrightText: Â© 2023 Alan Jian <alanjian85@outlook.com>
# SPDX-License-Identifier: GPL-3.0

# -nostdlib: Don't link to any of the standard library object files
LDFLAGS = -nostdlib
# -mcmodel=medany: With this option, the generated code can access data
#                  beyond the 32-bit address space
# -ffreestanding: Assert that compilation targets a freestanding
#                 environment
CFLAGS = -std=gnu11 -mcmodel=medany -ffreestanding

# Automatic source file matching and substituting
SRCS = $(wildcard *.S *.c)
OBJS = $(patsubst %.S,%.o,$(SRCS))
OBJS := $(patsubst %.c,%.o,$(OBJS))
DEPS = $(patsubst %.o,%.d,$(OBJS))

all: $(BUILDDIR)/kernel.elf

# Link the object files with the customized linker script and output to
# the build directory
$(BUILDDIR)/kernel.elf: kernel.ld $(OBJS)
	$(LD) -T kernel.ld $(OBJS) $(LDFLAGS) -o $@

$(OBJSDIR)/%.o: %.S
	$(CC) $< -MMD $(CFLAGS) -c -o $@

$(OBJSDIR)/%.o: %.c
	$(CC) $< -MMD $(CFLAGS) -c -o $@

# Use header dependency files generated by compiler
-include $(DEPS)
